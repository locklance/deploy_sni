# Инструкция по настройке DNS балансировки для XRAY
С помощью данной инструкции вы сможете корректно настроить DNS балансировку xray нод. 

> ### XRAY 
> Данный метод отлично подходит для балансировки xray конфигов, использующих self-steal SNI!
> Если вы еще не поставили self-steal, настоятельно рекомендуем это сделать! [Как установить self-steal SNI?](/README.RU.md)

## Немного теории
Допустим у нас есть несколько конечных серверов с различными ip адресами и один домен. При такой схеме мы сразу же сталкиваемся с проблемой выпуска доверенных сертификатов. Если при выпуске сертификата на первом сервере проблем никаких не должно возникнуть, то при выпуске сертификата для второго сервера, на который указывает тот же домен мы получим ошибку. 

Проблема заключается в том, что по умолчанию ACME-клиент осуществляет проверку сертификата с помощью HTTP-01, которая не позволяет получить сертификат, если домен уже ведет на другой ip адрес. 

![Проблема HTTP-01](/docs/media/http-01.png)

> ### Что такое проверка HTTP-01?
> Let’s Encrypt выдаёт ACME-клиенту токен, а ACME-клиент записывает этот токен в файл на web-сервере, используя путь http://YOUR_DOMAIN/.well-known/acme-challenge/TOKEN. В этом файле содержится сам токен, плюс отпечаток ключа вашего аккаунта. Как только ACME-клиент сообщит Let’s Encrypt, что файл готов, Let’s Encrypt будет пытаться получить этот файл по URL (возможно, несколько раз, с различных адресов). Если полученный ответ будет верным, проверка считается успешной. ©Let's Encrypt

Проверка HTTP-01 выполняется только с использованием порта 80, поэтому данный порт должен быть обязательно открыт для осуществления проверки. 

Чтобы **решить данную проблему** можно использовать какой-то отдельный сервер, который получал бы новые сертификаты и далее распределял их по нужным серверам, которые мы собираемся балансировать. Но есть метод гораздо более простой и надежный - выпуск доверенного сертификата с использование проверки DNS-01. 

![Получение сертификата с DNS-01](/docs/media/dns-01.png)

> ### Что такое проверка DNS-01?
> Эта проверка требует подтверждения прав на домен с помощью специальной TXT-записи для доменного имени. Это сложнее в настройке, чем для проверки HTTP-01, но покрывает сценарии использования, недоступные для проверки HTTP-01. Кроме того, проверка DNS-01 разрешает выпускать сертификаты с подстановкой (wildcard-сертификаты). После того, как Let’s Encrypt передаёт ACME-клиенту токен, клиент создаёт содержимое TXT-записи на основе токена и ключа аккаунта, и записывает её в _acme-challenge.YOUR_DOMAIN. Далее, Let’s Encrypt запрашивает TXT-запись в DNS-зоне домена. Если значения совпадают - сертификат готов к использованию. ©Let's Encrypt

## Настройка DNS балансировки xray нод

---
### Этапы:
1. Запускаем self-steal SNI
2. Настройка Xray
---
### 1. Запускаем self-steal SNI
Запускаем self-steal SNI по [инструкции](README.RU.md)

### 2. Настройка Xray
Настроим Xray под DNS балансировку, используя конфигурацию Vless + Reality + Selfsteal:

```json
{
  "inbounds": [
    {
      "tag": "RUSSIA_VLESS_RAW",
      "port": 443,
      "listen": "0.0.0.0",
      "protocol": "vless",
      "settings": {
        "clients": [],
        "decryption": "none"
      },
      "sniffing": {
        "enabled": true,
        "routeOnly": false,
        "destOverride": [
          "http",
          "tls",
          "quic",
          "fakedns"
        ],
        "metadataOnly": false
      },
      "streamSettings": {
        "network": "raw",
        "security": "reality",
        "realitySettings": {
          "dest": "localhost:9443", 
          "show": false,
          "xver": 1,
          "spiderX": "/",
          "shortIds": [
            "15dsdadawf04c7bb",
          ],
          "privateKey": "nswdjsdooawdpNSda-Olsdk1qkdfp3pofibf-0asd3ovas",
          "fingerprint": "chrome",
          "serverNames": [
            "fl.hozyaka.com" // <---- PUT YOUR DOMAIN HERE
          ]
        }
      }
    }
  ],
  "outbounds": [
    {
      "tag": "DIRECT",
      "protocol": "freedom"
    },
    {
      "tag": "BLOCK",
      "protocol": "blackhole"
    }
  ]
}
```


Чтобы подключить DNS балансировку копируем данный конфиг на все сервера под одним доменом (в примере `fl.hozyaka.com`). 
Пример балансировки 3-х нод:
![Пример балансировки](/docs/media/dns-balancer-example.png)